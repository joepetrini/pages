<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project P&L Report - Field Reference Table</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1400px;
        }
        thead {
            background-color: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            border-right: 1px solid #34495e;
        }
        th:last-child {
            border-right: none;
        }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
            border-right: 1px solid #ecf0f1;
            vertical-align: top;
        }
        td:last-child {
            border-right: none;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        .field-name {
            font-weight: bold;
            color: #2c3e50;
            white-space: nowrap;
        }
        .tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }
        .tag-reference { background-color: #6c757d; color: white; }
        .tag-revenue { background-color: #28a745; color: white; }
        .tag-cost { background-color: #dc3545; color: white; }
        .tag-calculated { background-color: #17a2b8; color: white; }
        .tag-margin { background-color: #ffc107; color: black; }
        .tag-debug { background-color: #6f42c1; color: white; }
        code {
            background-color: #f4f4f4;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: nowrap;
        }
        .formula {
            background-color: #fff3cd;
            padding: 4px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            margin: 3px 0;
            display: inline-block;
        }
        .warning-icon {
            color: #ffc107;
            font-weight: bold;
        }
        .info-icon {
            color: #17a2b8;
            font-weight: bold;
        }
        .success-icon {
            color: #28a745;
            font-weight: bold;
        }
        .category-row {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }
        .category-row td {
            padding: 8px;
            border-bottom: 2px solid #2c3e50;
        }
        .notes {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }
        .print-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .print-btn:hover {
            background-color: #2980b9;
        }
        @media print {
            .print-btn {
                display: none;
            }
            body {
                background-color: white;
            }
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Project P&L Report - Field Reference Table (V2)</h1>
        <p class="subtitle">Comprehensive reference guide for all project-level profit & loss fields (47+ fields) | Now with Finance-Validated Cost Data</p>

        <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>

        <table>
            <thead>
                <tr>
                    <th style="width: 200px;">Field Name</th>
                    <th style="width: 100px;">Category</th>
                    <th style="width: 250px;">Data Source</th>
                    <th style="width: 350px;">Calculation / Formula</th>
                    <th style="width: 300px;">Description</th>
                    <th style="width: 250px;">Status / Notes</th>
                </tr>
            </thead>
            <tbody>
                <!-- REFERENCE FIELDS SECTION -->
                <tr class="category-row">
                    <td colspan="6">REFERENCE FIELDS - Project Identifying Information (10 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Account</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.account_name</code></td>
                    <td>Direct field value from Loome organization</td>
                    <td>Account/organization name for this project</td>
                    <td><span class="success-icon">‚úì</span> Synced from Loome</td>
                </tr>

                <tr>
                    <td class="field-name">Customer</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.customer_name</code></td>
                    <td>Direct field value from Loome organization</td>
                    <td>Customer organization name</td>
                    <td><span class="success-icon">‚úì</span> Synced from Loome</td>
                </tr>

                <tr>
                    <td class="field-name">Project</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.name</code></td>
                    <td>Direct field value</td>
                    <td>Project name/identifier</td>
                    <td><span class="success-icon">‚úì</span> Synced from House</td>
                </tr>

                <tr>
                    <td class="field-name">Project Manager</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.project_manager</code></td>
                    <td><div class="formula">CONCAT(first_name, ' ', last_name)</div>From Loome core_users</td>
                    <td>Full name of assigned project manager</td>
                    <td><span class="success-icon">‚úì</span> Synced from Loome</td>
                </tr>

                <tr>
                    <td class="field-name">State</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.state</code></td>
                    <td><div class="formula">Loome project.address->>'state'</div></td>
                    <td>Project delivery state from address JSON</td>
                    <td><span class="success-icon">‚úì</span> Synced from Loome address field</td>
                </tr>

                <tr>
                    <td class="field-name">First Order Date</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.first_order_date</code></td>
                    <td><div class="formula">MIN(orders.created_at::date)</div>Aggregated in DAG</td>
                    <td>Date of first order in project</td>
                    <td><span class="success-icon">‚úì</span> Calculated in DAG</td>
                </tr>

                <tr>
                    <td class="field-name">Last Order Date</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.last_order_date</code></td>
                    <td><div class="formula">MAX(orders.created_at::date)</div>Aggregated in DAG</td>
                    <td>Date of most recent order in project</td>
                    <td><span class="success-icon">‚úì</span> Calculated in DAG</td>
                </tr>

                <tr>
                    <td class="field-name">Order Count</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.order_count</code></td>
                    <td><div class="formula">COUNT(*)</div>Aggregated in DAG</td>
                    <td>Total number of orders in project</td>
                    <td><span class="success-icon">‚úì</span> Calculated in DAG</td>
                </tr>

                <tr>
                    <td class="field-name">PO Count</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.po_count</code></td>
                    <td><div class="formula">COUNT(DISTINCT po.increment_id)</div>Aggregated in DAG</td>
                    <td>Total number of purchase orders in project</td>
                    <td><span class="success-icon">‚úì</span> Calculated in DAG</td>
                </tr>

                <tr>
                    <td class="field-name">Status</td>
                    <td><span class="tag tag-reference">REFERENCE</span></td>
                    <td><code>projects.status</code></td>
                    <td>Direct field value from Loome project</td>
                    <td>Current project status</td>
                    <td><span class="success-icon">‚úì</span> Synced from Loome</td>
                </tr>

                <!-- REVENUE INVOICED SECTION -->
                <tr class="category-row">
                    <td colspan="6">REVENUE - INVOICED - Customer Charges from Orders (4 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Product Revenue Invoiced</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td><code>order_items.gross_revenue</code></td>
                    <td><div class="formula">SUM(oi.gross_revenue)<br>WHERE inv.is_deposit = FALSE</div>Excludes deposit invoices</td>
                    <td>Total product revenue from customer invoices</td>
                    <td><span class="success-icon">‚úì</span> Deposit filtering active</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping Revenue Invoiced</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td><code>orders.shipping_amount</code></td>
                    <td><div class="formula">SUM(o.shipping_amount)<br>WHERE inv.is_deposit = FALSE</div></td>
                    <td>Shipping charges billed to customer</td>
                    <td><span class="success-icon">‚úì</span> Deposit filtering active</td>
                </tr>

                <tr>
                    <td class="field-name">Sales Tax Invoiced</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td><code>orders.tax_amount</code></td>
                    <td><div class="formula">SUM(o.tax_amount)<br>WHERE inv.is_deposit = FALSE</div></td>
                    <td>Sales tax collected from customer</td>
                    <td><span class="success-icon">‚úì</span> Deposit filtering active</td>
                </tr>

                <tr>
                    <td class="field-name">Fees Invoiced</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td>TBD</td>
                    <td><div class="formula">0::NUMERIC</div>Placeholder</td>
                    <td>Additional fees charged to customer</td>
                    <td><span class="warning-icon">‚ö†Ô∏è</span> TODO: Identify fee fields</td>
                </tr>

                <!-- REVENUE CREDITS SECTION -->
                <tr class="category-row">
                    <td colspan="6">REVENUE - CREDITS - Customer Refunds & Credits (4 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Product Revenue Credit</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td><code>refunds.subtotal</code></td>
                    <td><div class="formula">SUM(r.subtotal)</div>From credit memos</td>
                    <td>Product revenue refunded to customer</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping Revenue Credit</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td><code>refunds.shipping_amount</code></td>
                    <td><div class="formula">SUM(r.shipping_amount)</div></td>
                    <td>Shipping charges refunded to customer</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Sales Tax Credit</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td><code>refunds.tax_amount</code></td>
                    <td><div class="formula">SUM(r.tax_amount)</div></td>
                    <td>Sales tax refunded to customer</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Fees Credit</td>
                    <td><span class="tag tag-revenue">REVENUE</span></td>
                    <td><code>refunds.adjustment_negative</code></td>
                    <td><div class="formula">SUM(r.adjustment_negative)</div></td>
                    <td>Fee adjustments/credits to customer</td>
                    <td><span class="warning-icon">‚ö†Ô∏è</span> May need refinement</td>
                </tr>

                <!-- REVENUE NET SECTION -->
                <tr class="category-row">
                    <td colspan="6">REVENUE - NET - Realized Revenue After Credits (5 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Product Revenue Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Product Revenue Invoiced<br>- Product Revenue Credit</div></td>
                    <td>Net product revenue after refunds</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping Revenue Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Shipping Revenue Invoiced<br>- Shipping Revenue Credit</div></td>
                    <td>Net shipping revenue after refunds</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Sales Tax Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Sales Tax Invoiced<br>- Sales Tax Credit</div></td>
                    <td>Net sales tax collected</td>
                    <td><span class="info-icon">‚ÑπÔ∏è</span> Informational only</td>
                </tr>

                <tr>
                    <td class="field-name">Fees Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Fees Invoiced - Fees Credit</div></td>
                    <td>Net fees collected</td>
                    <td><span class="warning-icon">‚ö†Ô∏è</span> Pending fee field ID</td>
                </tr>

                <tr>
                    <td class="field-name">Net Revenue</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Product Revenue Net<br>+ Shipping Revenue Net</div></td>
                    <td>Total realized revenue from customer</td>
                    <td><span class="success-icon">‚úì</span> Primary revenue metric</td>
                </tr>

                <!-- COST BILLED SECTION -->
                <tr class="category-row">
                    <td colspan="6">COST - BILLED - Vendor Invoices & Charges (7 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Product Invoiced</td>
                    <td><span class="tag tag-cost">COST</span></td>
                    <td><code>po_profit.product_invoiced</code></td>
                    <td><div class="formula">SUM(pp.product_invoiced)</div>VALIDATED by finance team</td>
                    <td>Product costs from vendor invoices</td>
                    <td><span class="success-icon">‚úì</span> Validated data source</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping Invoiced</td>
                    <td><span class="tag tag-cost">COST</span></td>
                    <td><code>po_profit.shipping_invoiced</code></td>
                    <td><div class="formula">SUM(pp.shipping_invoiced)</div>VALIDATED by finance team</td>
                    <td>Inbound freight charged by vendor</td>
                    <td><span class="success-icon">‚úì</span> Validated data source</td>
                </tr>

                <tr>
                    <td class="field-name">Misc Invoiced</td>
                    <td><span class="tag tag-cost">COST</span></td>
                    <td><code>po_profit.misc_invoiced</code></td>
                    <td><div class="formula">SUM(pp.misc_invoiced)</div>VALIDATED by finance team</td>
                    <td>Miscellaneous vendor charges (tariffs, etc.)</td>
                    <td><span class="success-icon">‚úì</span> Validated data source</td>
                </tr>

                <tr>
                    <td class="field-name">Carrier Shipping</td>
                    <td><span class="tag tag-cost">COST</span></td>
                    <td><code>po_profit.carrier_shipping</code></td>
                    <td><div class="formula">SUM(pp.carrier_shipping)</div>VALIDATED by finance team</td>
                    <td>Outbound shipping to customer (UPS, FedEx, etc.)</td>
                    <td><span class="success-icon">‚úì</span> Validated data source</td>
                </tr>

                <tr>
                    <td class="field-name">Product CM</td>
                    <td><span class="tag tag-cost">COST</span></td>
                    <td><code>po_profit.product_cm</code></td>
                    <td><div class="formula">SUM(pp.product_cm)</div>VALIDATED by finance team</td>
                    <td>Product credit memos from vendor</td>
                    <td><span class="success-icon">‚úì</span> Validated data source</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping CM</td>
                    <td><span class="tag tag-cost">COST</span></td>
                    <td><code>po_profit.shipping_cm</code></td>
                    <td><div class="formula">SUM(pp.shipping_cm)</div>VALIDATED by finance team</td>
                    <td>Shipping credit memos from vendor</td>
                    <td><span class="success-icon">‚úì</span> Validated data source</td>
                </tr>

                <tr>
                    <td class="field-name">Misc CM</td>
                    <td><span class="tag tag-cost">COST</span></td>
                    <td><code>po_profit.misc_cm</code></td>
                    <td><div class="formula">SUM(pp.misc_cm)</div>VALIDATED by finance team</td>
                    <td>Misc fee credit memos from vendor</td>
                    <td><span class="success-icon">‚úì</span> Validated data source</td>
                </tr>

                <!-- COST NET SECTION -->
                <tr class="category-row">
                    <td colspan="6">COST - NET - Actual Costs After Credits (4 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Product Invoiced Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">-1 * (Product Invoiced - Product CM)</div>Spec requires sign flip</td>
                    <td>Net product cost after vendor credits</td>
                    <td><span class="info-icon">‚ÑπÔ∏è</span> Negative multiplier per spec</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping Invoiced Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">-1 * (Shipping Invoiced - Shipping CM)</div></td>
                    <td>Net inbound shipping cost</td>
                    <td><span class="info-icon">‚ÑπÔ∏è</span> Negative multiplier per spec</td>
                </tr>

                <tr>
                    <td class="field-name">Misc Invoiced Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">-1 * (Misc Invoiced - Misc CM)</div></td>
                    <td>Net misc charges</td>
                    <td><span class="info-icon">‚ÑπÔ∏è</span> Negative multiplier per spec</td>
                </tr>

                <tr>
                    <td class="field-name">Carrier Shipping Net</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">-1 * Carrier Shipping</div></td>
                    <td>Net outbound shipping cost</td>
                    <td><span class="info-icon">‚ÑπÔ∏è</span> Negative multiplier per spec</td>
                </tr>

                <!-- COST TOTAL SECTION -->
                <tr class="category-row">
                    <td colspan="6">COST - TOTAL - All-In Cost Summary (1 field)</td>
                </tr>

                <tr>
                    <td class="field-name">Net Cost</td>
                    <td><span class="tag tag-calculated">CALCULATED</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">-1 * ((Product Invoiced - Product CM)<br>+ (Shipping Invoiced - Shipping CM)<br>+ (Misc Invoiced - Misc CM)<br>+ Carrier Shipping)</div></td>
                    <td>Total all-in cost including all vendor and carrier charges</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <!-- GROSS MARGIN VALUES SECTION -->
                <tr class="category-row">
                    <td colspan="6">GROSS MARGIN - VALUES - Dollar Profit by Category (3 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Product Margin Val</td>
                    <td><span class="tag tag-margin">MARGIN</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Product Revenue Net<br>- Product Invoiced Net</div></td>
                    <td>Dollar profit on products only</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping Margin Val</td>
                    <td><span class="tag tag-margin">MARGIN</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Shipping Revenue Net<br>- (Shipping Invoiced Net<br>+ Carrier Shipping Net)</div></td>
                    <td>Dollar profit/loss on shipping (includes inbound & outbound)</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Gross Margin Val</td>
                    <td><span class="tag tag-margin">MARGIN</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">Product Margin Val<br>+ Shipping Margin Val</div></td>
                    <td>Total dollar profit for project</td>
                    <td><span class="success-icon">‚úì</span> Primary profit metric</td>
                </tr>

                <!-- GROSS MARGIN PERCENTAGES SECTION -->
                <tr class="category-row">
                    <td colspan="6">GROSS MARGIN - PERCENTAGES - Profitability Ratios (3 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">Product Margin Pct</td>
                    <td><span class="tag tag-margin">MARGIN</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">(Product Margin Val<br>/ NULLIF(Product Revenue Net, 0))<br>* 100</div>Returns 0 if no revenue</td>
                    <td>Product profitability percentage</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>

                <tr>
                    <td class="field-name">Shipping Margin Pct</td>
                    <td><span class="tag tag-margin">MARGIN</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">(Shipping Margin Val<br>/ NULLIF(Shipping Revenue Net, 0))<br>* 100</div>Returns 0 if no revenue</td>
                    <td>Shipping profitability percentage</td>
                    <td><span class="info-icon">‚ÑπÔ∏è</span> Often negative</td>
                </tr>

                <tr>
                    <td class="field-name">Gross Margin Pct</td>
                    <td><span class="tag tag-margin">MARGIN</span></td>
                    <td>Calculated</td>
                    <td><div class="formula">(Gross Margin Val<br>/ NULLIF(Net Revenue, 0))<br>* 100</div>Returns 0 if no revenue</td>
                    <td>Overall project profitability percentage</td>
                    <td><span class="success-icon">‚úì</span> Key KPI</td>
                </tr>

                <!-- DEBUG FIELDS SECTION -->
                <tr class="category-row">
                    <td colspan="6">DEBUG FIELDS - Data Quality & Status Checks (4 fields)</td>
                </tr>

                <tr>
                    <td class="field-name">All Orders Complete</td>
                    <td><span class="tag tag-debug">DEBUG</span></td>
                    <td>TBD</td>
                    <td><div class="formula">NULL::BOOLEAN</div>Placeholder</td>
                    <td>Flag if all orders in project are in complete status</td>
                    <td><span class="warning-icon">‚ö†Ô∏è</span> TODO: Check order statuses</td>
                </tr>

                <tr>
                    <td class="field-name">Pct Invoiced</td>
                    <td><span class="tag tag-debug">DEBUG</span></td>
                    <td>TBD</td>
                    <td><div class="formula">NULL::NUMERIC</div>Placeholder<br>Spec: [Net Invoice where not Deposit] / Net Order Value</td>
                    <td>Percentage of order value that has been invoiced</td>
                    <td><span class="warning-icon">‚ö†Ô∏è</span> TODO: Calculate order value</td>
                </tr>

                <tr>
                    <td class="field-name">Has Pull From Stock</td>
                    <td><span class="tag tag-debug">DEBUG</span></td>
                    <td>TBD</td>
                    <td><div class="formula">NULL::BOOLEAN</div>Placeholder<br>Check purchase_orders.workflow</td>
                    <td>Flag if any POs use pull_from_stock workflow</td>
                    <td><span class="warning-icon">‚ö†Ô∏è</span> TODO: Check workflow field</td>
                </tr>

                <tr>
                    <td class="field-name">Current DateStamp YYYYMMDD</td>
                    <td><span class="tag tag-debug">DEBUG</span></td>
                    <td>System</td>
                    <td><div class="formula">TO_CHAR(CURRENT_DATE, 'YYYYMMDD')</div></td>
                    <td>Report generation date in YYYYMMDD format</td>
                    <td><span class="success-icon">‚úì</span> Complete</td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 5px;">
            <h3 style="margin-top: 0;">Field Categories Summary</h3>
            <p><strong>Categories:</strong></p>
            <ul style="list-style: none; padding-left: 0;">
                <li><span class="tag tag-reference">REFERENCE</span> - Project identifying information (10 fields)</li>
                <li><span class="tag tag-revenue">REVENUE</span> - Customer revenue invoiced and credited (8 fields)</li>
                <li><span class="tag tag-cost">COST</span> - Vendor and carrier costs (11 fields)</li>
                <li><span class="tag tag-calculated">CALCULATED</span> - Net values derived from other fields (10 fields)</li>
                <li><span class="tag tag-margin">MARGIN</span> - Profit values and percentages (6 fields)</li>
                <li><span class="tag tag-debug">DEBUG</span> - Data quality and status flags (4 fields)</li>
            </ul>

            <p><strong>Status Indicators:</strong></p>
            <ul style="list-style: none; padding-left: 0;">
                <li><span class="success-icon">‚úì</span> - Field is complete and working</li>
                <li><span class="warning-icon">‚ö†Ô∏è</span> - Field needs refinement or is TODO</li>
                <li><span class="info-icon">‚ÑπÔ∏è</span> - Additional context or information</li>
            </ul>

            <p><strong>Key Data Sources:</strong></p>
            <ul>
                <li><code>projects</code> - Pre-aggregated project metadata from sync DAG</li>
                <li><code>orders</code> + <code>order_items</code> - Customer order revenue</li>
                <li><code>refunds</code> - Customer credits and refunds</li>
                <li><code>po_profit</code> - <strong>VALIDATED</strong> vendor costs and credits (all COST fields - V2 update)</li>
                <li><code>finance.invoices</code> - Invoice metadata with deposit flag</li>
            </ul>

            <p><strong>Important Business Rules:</strong></p>
            <ul>
                <li>Deposit invoices are <strong>excluded</strong> from revenue calculations (is_deposit = false)</li>
                <li>Cost values use <strong>-1 multiplier</strong> per spec to make values positive</li>
                <li>All COST data sourced from <strong>finance-validated</strong> <code>po_profit</code> table (V2 update)</li>
                <li>Shipping margin includes both inbound (vendor) and outbound (carrier) costs</li>
                <li>All percentages return 0 when denominator is 0 (using NULLIF)</li>
                <li>Project data is pre-aggregated in DAG for performance</li>
            </ul>

            <p><strong>Outstanding TODO Items:</strong></p>
            <ol>
                <li>Fees fields - Need to identify fee columns in orders and refunds tables</li>
                <li>All Orders Complete - Need to query order statuses and determine completion criteria</li>
                <li>Pct Invoiced - Need to calculate net order value vs invoiced amount</li>
                <li>Has Pull From Stock - Need to check purchase_orders.workflow field for 'pull_from_stock'</li>
            </ol>

            <p><strong>V2 Updates (Completed):</strong></p>
            <ul>
                <li><span class="success-icon">‚úì</span> All COST fields now use finance-validated <code>po_profit</code> table</li>
                <li><span class="success-icon">‚úì</span> Product CM, Shipping CM, and Misc CM properly separated</li>
                <li><span class="success-icon">‚úì</span> Cost methodology matches finance team's validated approach</li>
            </ul>
        </div>

        <p style="text-align: center; color: #7f8c8d; font-size: 0.9em; margin-top: 30px;">
            <strong>Generated:</strong> 2025-11-13 | <strong>Query File:</strong> project_pnl_query_v2.sql | <strong>Version:</strong> 2.0 (Finance Validated) | <strong>Total Fields:</strong> 47
        </p>
    </div>

    <script>
        // Add row numbers
        const tbody = document.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr:not(.category-row)');
        let rowNum = 1;
        rows.forEach(row => {
            const firstCell = row.querySelector('td:first-child');
            if (firstCell && !firstCell.classList.contains('category-row')) {
                firstCell.innerHTML = `${rowNum}. ${firstCell.innerHTML}`;
                rowNum++;
            }
        });
    </script>
</body>
</html>
