<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project P&L Report V3 - Field Documentation</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 32px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 24px;
        }
        .field-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.3s ease;
        }
        .field-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        .field-name {
            font-size: 22px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            background-color: #f0f3ff;
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .field-section {
            margin: 15px 0;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
        }
        .label {
            font-weight: 700;
            color: #2c3e50;
            display: inline-block;
            min-width: 140px;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .value {
            color: #34495e;
            line-height: 1.6;
        }
        .code {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }
        .dag-info {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .warehouse-info {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .source-info {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .loome-info {
            background-color: #e1f5fe;
            border-left: 4px solid #03a9f4;
            padding: 12px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .calc-badge {
            display: inline-block;
            background-color: #9b59b6;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
        }
        .summary h3 {
            margin-top: 0;
            color: #1565c0;
        }
        .field-type {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
            text-transform: uppercase;
        }
        .type-reference { background-color: #e3f2fd; color: #1976d2; }
        .type-revenue { background-color: #e8f5e9; color: #388e3c; }
        .type-cost { background-color: #ffebee; color: #d32f2f; }
        .type-calculated { background-color: #f3e5f5; color: #7b1fa2; }
        .type-loome { background-color: #e1f5fe; color: #03a9f4; }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Project P&L Report V3 - Field Documentation</h1>

        <div class="summary">
            <h3>Report Overview</h3>
            <p><strong>Query File:</strong> project_pnl_query_v3.sql</p>
            <p><strong>Target Database:</strong> warehouse (PostgreSQL)</p>
            <p><strong>Primary Table:</strong> public.projects</p>
            <p><strong>Purpose:</strong> Comprehensive project-level P&L analysis with revenue (from Loome finance stats), costs (from validated po_profit), and margin calculations</p>
            <p><strong>Major Improvement in V3:</strong> Uses pre-calculated finance stats from Loome instead of parsing JSON from invoices - 10-100x faster!</p>
        </div>

        <h2>üìã Field Categories</h2>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Field Count</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Reference Fields</strong></td>
                    <td>11</td>
                    <td>Project identifiers and metadata (dates, names, counts, status)</td>
                </tr>
                <tr>
                    <td><strong>Revenue - Invoiced (from Loome)</strong></td>
                    <td>4</td>
                    <td>Customer revenue from invoices (product, shipping, tax, fees)</td>
                </tr>
                <tr>
                    <td><strong>Revenue - Credits (from Loome)</strong></td>
                    <td>4</td>
                    <td>Customer refunds from credit memos (product, shipping, tax, fees)</td>
                </tr>
                <tr>
                    <td><strong>Revenue - Net (Calculated)</strong></td>
                    <td>5</td>
                    <td>Net revenue after credits (invoiced - credits)</td>
                </tr>
                <tr>
                    <td><strong>Cost - Billed (from po_profit)</strong></td>
                    <td>7</td>
                    <td>Vendor costs and carrier shipping (product, shipping, misc, carrier, CMs)</td>
                </tr>
                <tr>
                    <td><strong>Cost - Net (Calculated)</strong></td>
                    <td>5</td>
                    <td>Net costs after vendor credits (invoiced - CMs)</td>
                </tr>
                <tr>
                    <td><strong>Gross Margin (Calculated)</strong></td>
                    <td>6</td>
                    <td>Profit margins (values and percentages)</td>
                </tr>
                <tr>
                    <td><strong>Debug Fields</strong></td>
                    <td>3</td>
                    <td>Status flags and timestamps</td>
                </tr>
            </tbody>
        </table>

        <h2>üîµ Reference Fields</h2>

        <div class="field-card">
            <div class="field-name">Project ID<span class="field-type type-reference">REFERENCE</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Unique identifier for the project (UUID from House DB crm_opportunity table)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.project_id (uuid)
            </div>

            <div class="dag-info">
                <strong>DAG:</strong> sync_projects.py<br>
                <strong>Task:</strong> house_sync_projects (line 20-33)
            </div>

            <div class="source-info">
                <strong>Source DB:</strong> house_postgres<br>
                <strong>Source View:</strong> v_project_items<br>
                <strong>Source Field:</strong> opportunity_id
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Account<span class="field-type type-reference">REFERENCE</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Account organization name (parent company for the project)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.account_name (varchar)
            </div>

            <div class="dag-info">
                <strong>DAG:</strong> sync_projects.py<br>
                <strong>Task:</strong> loome_project_manager (line 174-208)
            </div>

            <div class="loome-info">
                <strong>Loome DB:</strong> loome_postgres<br>
                <strong>Loome Tables:</strong> project ‚Üí organization<br>
                <strong>Loome Field:</strong> o.name (where o = account_organization)
            </div>

            <div class="field-section">
                <div class="label">SQL Extract:</div>
                <div class="code">SELECT o.name account_name
FROM project p
LEFT JOIN organization o ON p.account_organization_id=o.id
INNER JOIN project_link l ON l.project_id = p.id AND l.type = 'HP'
WHERE l.house_id IS NOT NULL</div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Customer<span class="field-type type-reference">REFERENCE</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Customer organization name (end customer for the project)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.customer_name (varchar)
            </div>

            <div class="loome-info">
                <strong>Loome DB:</strong> loome_postgres<br>
                <strong>Loome Tables:</strong> project ‚Üí organization<br>
                <strong>Loome Field:</strong> co.name (where co = customer_organization)
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Project<span class="field-type type-reference">REFERENCE</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Project name/title</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.name (varchar)
            </div>

            <div class="dag-info">
                <strong>DAG:</strong> sync_projects.py<br>
                <strong>Task:</strong> house_sync_projects
            </div>

            <div class="source-info">
                <strong>Source DB:</strong> house_postgres<br>
                <strong>Source View:</strong> v_project_items<br>
                <strong>Source Field:</strong> project_name
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Project Manager / State / Status<span class="field-type type-reference">REFERENCE</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Project manager name, shipping state, and project status from Loome</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.project_manager, projects.state, projects.status
            </div>

            <div class="loome-info">
                <strong>Loome Source:</strong><br>
                ‚Ä¢ project_manager: CONCAT(u.first_name, ' ', u.last_name) from core_users<br>
                ‚Ä¢ state: p.address->>'state' (JSONB extraction)<br>
                ‚Ä¢ status: p.status
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">First/Last Order Date, Order Count, PO Count<span class="field-type type-reference">REFERENCE</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Order date range and counts aggregated from orders and purchase_orders tables</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.first_order_date, projects.last_order_date, projects.order_count, projects.po_count
            </div>

            <div class="dag-info">
                <strong>DAG:</strong> sync_projects.py<br>
                <strong>Tasks:</strong> house_sync_order_metrics (line 74-136), house_sync_po_projects (line 37-53)
            </div>

            <div class="field-section">
                <div class="label">Calculation:</div>
                <div class="code">-- From orders table
MIN(created_at::date) first_order_date,
MAX(created_at::date) last_order_date,
COUNT(*) order_count

-- From purchase_orders table
COUNT(DISTINCT po.increment_id) po_count</div>
            </div>
        </div>

        <h2>üí∞ Revenue - Invoiced (from Loome Finance Stats)</h2>

        <div class="field-card">
            <div class="field-name">Product Revenue Invoiced<span class="field-type type-loome">FROM LOOME</span><span class="calc-badge">V3 NEW</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Total product revenue from customer invoices (excludes tax, shipping, fees)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.product_revenue_invoiced (numeric 12,2)
            </div>

            <div class="dag-info">
                <strong>DAG:</strong> sync_projects.py<br>
                <strong>Task:</strong> loome_project_manager (line 174-208)<br>
                <strong>Sync Frequency:</strong> Hourly
            </div>

            <div class="loome-info">
                <strong>Loome Source:</strong> project.daily_stat->>'product_invoiced'<br>
                <strong>Loome Calculation:</strong> apps/finance/stats.py ‚Üí _update_invoice_stats() ‚Üí _update_project_stats()<br>
                <strong>Data Flow:</strong> QuickBooks ‚Üí Loome Invoice ‚Üí Stats Calc ‚Üí project.daily_stat ‚Üí DAG ‚Üí Warehouse
            </div>

            <div class="field-section">
                <div class="label">Loome Stats Logic (stats.py lines 105-176):</div>
                <div class="code">for item in invoice.quickbooks_json.get("Line", []):
    account = item.get("SalesItemLineDetail", {}).get("ItemRef", {}).get("name")
    amount = round(convert_to_float(item.get("Amount")), 2)

    # Product mapping
    if regex_isearch(["Sales", "Fixtures & Bulb", "Fixtures and Bulb"], account):
        stats["product_invoiced"] += amount

# Aggregated at project level
for invoice in project.invoices.all():
    project_stats["product_invoiced"] += invoice.daily_stat["product_invoiced"]</div>
            </div>

            <div class="field-section">
                <div class="label">DAG Sync SQL:</div>
                <div class="code">SELECT
    l.house_id AS project_id,
    COALESCE((p.daily_stat->>'product_invoiced')::numeric, 0) AS product_revenue_invoiced
FROM project p
INNER JOIN project_link l ON l.project_id = p.id AND l.type = 'HP'</div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Shipping Revenue Invoiced<span class="field-type type-loome">FROM LOOME</span><span class="calc-badge">V3 NEW</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Shipping charges billed to customer on invoices</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.shipping_revenue_invoiced (numeric 12,2)
            </div>

            <div class="loome-info">
                <strong>Loome Source:</strong> project.daily_stat->>'shipping_invoiced'<br>
                <strong>QB Account Mapping:</strong> "Freight", "Shipping & Handling"
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Sales Tax Invoiced<span class="field-type type-loome">FROM LOOME</span><span class="calc-badge">V3 NEW</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Sales tax collected from customer on invoices</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.sales_tax_invoiced (numeric 12,2)
            </div>

            <div class="loome-info">
                <strong>Loome Source:</strong> project.daily_stat->>'tax_invoiced'<br>
                <strong>QB Account Mapping:</strong> "Sales Tax"<br>
                <strong>Also Calculated From:</strong> invoice.total_incl_tax - invoice.total_excl_tax
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Fees Invoiced<span class="field-type type-loome">FROM LOOME</span><span class="calc-badge">V3 NEW</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">All fees charged to customer (credit card fees + design fees)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.fees_invoiced (numeric 12,2)
            </div>

            <div class="loome-info">
                <strong>Loome Source:</strong> project.daily_stat->>'fees_invoiced'<br>
                <strong>Loome Calculation:</strong> credit_card_fees + design_fees
            </div>

            <div class="field-section">
                <div class="label">Components:</div>
                <div class="value">
                    <strong>Credit Card Fees:</strong> QB Accounts: "Fee Income", "Credit Card Fee", "DS - Service Fees"<br>
                    <strong>Design Fees:</strong> QB Accounts: "Professional" OR Description contains "Lighting Design"
                </div>
            </div>
        </div>

        <h2>üí∏ Revenue - Credits (from Loome Finance Stats)</h2>

        <div class="field-card">
            <div class="field-name">Product Revenue Credit<span class="field-type type-loome">FROM LOOME</span><span class="calc-badge">V3 NEW</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Product refunds/credits issued to customer via credit memos</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.product_revenue_credit (numeric 12,2)
            </div>

            <div class="loome-info">
                <strong>Loome Source:</strong> project.daily_stat->>'product_credit'<br>
                <strong>Loome Calculation:</strong> apps/finance/stats.py ‚Üí _update_credit_memo_stats() ‚Üí parses QB credit memo line items
            </div>

            <div class="field-section">
                <div class="label">Loome Stats Logic (stats.py lines 296-367):</div>
                <div class="code">for item in credit.quickbooks_json.get("Line", []):
    account = item.get("SalesItemLineDetail", {}).get("ItemRef", {}).get("name")
    amount = round(convert_to_float(item.get("Amount")), 2)

    # Product mapping (same as invoice)
    if regex_isearch(["Sales", "Fixtures & Bulb", "Fixtures and Bulb"], account):
        stats["product_credit"] += amount</div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Shipping/Tax/Fees Credit<span class="field-type type-loome">FROM LOOME</span><span class="calc-badge">V3 NEW</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Shipping, tax, and fee refunds from credit memos (same mapping logic as invoiced)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.shipping_revenue_credit, projects.sales_tax_credit, projects.fees_credit
            </div>

            <div class="loome-info">
                <strong>Loome Sources:</strong><br>
                ‚Ä¢ shipping_credit: Same QB account mapping as shipping_invoiced<br>
                ‚Ä¢ sales_tax_credit: QB Account "Sales Tax" OR calculated from credit.total_incl_tax - credit.total_excl_tax<br>
                ‚Ä¢ fees_credit: Same QB account mapping as fees_invoiced
            </div>
        </div>

        <h2>üìä Revenue - Net (Calculated in Query)</h2>

        <div class="field-card">
            <div class="field-name">Product/Shipping/Tax/Fees Revenue Net<span class="field-type type-calculated">CALCULATED</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Net revenue after refunds for each category</div>
            </div>

            <div class="field-section">
                <div class="label">Formula:</div>
                <div class="code">Product Revenue Net = product_revenue_invoiced - product_revenue_credit
Shipping Revenue Net = shipping_revenue_invoiced - shipping_revenue_credit
Sales Tax Net = sales_tax_invoiced - sales_tax_credit
Fees Net = fees_invoiced - fees_credit</div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Net Revenue<span class="field-type type-calculated">CALCULATED</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Total net revenue (product + shipping only, excludes tax and fees per spec)</div>
            </div>

            <div class="field-section">
                <div class="label">Formula:</div>
                <div class="code">Net Revenue = (product_revenue_invoiced - product_revenue_credit) +
              (shipping_revenue_invoiced - shipping_revenue_credit)</div>
            </div>
        </div>

        <h2>üíµ Cost - Billed (from po_profit table)</h2>

        <div class="field-card">
            <div class="field-name">Product Invoiced<span class="field-type type-cost">COST</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Total amount invoiced by vendors for products (what we pay suppliers)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> po_profit.product_invoiced ‚Üí aggregated to projects (numeric)
            </div>

            <div class="source-info">
                <strong>Source DB:</strong> house_postgres<br>
                <strong>Source Table:</strong> finance_invoice<br>
                <strong>Source View:</strong> v_po_profit_2025
            </div>

            <div class="field-section">
                <div class="label">View Calculation (v_po_profit_2025 lines 23-54):</div>
                <div class="code">sum(CASE WHEN fi.is_credit_memo = false
    THEN fi.invoice_total - COALESCE(fi.freight, 0) - COALESCE(fi.dropship_fee, 0)
    ELSE 0 END) AS product_invoiced

-- From finance_invoice table where:
-- is_validated = true
-- is_ignored = false
-- purchase_order_id IS NOT NULL</div>
            </div>

            <div class="field-section">
                <div class="label">Query Aggregation (project_pnl_query_v3.sql lines 36-56):</div>
                <div class="code">SELECT
    pp.project_id,
    SUM(pp.product_invoiced) AS product_invoiced
FROM po_profit pp
WHERE pp.project_id IS NOT NULL
GROUP BY pp.project_id</div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Shipping/Misc Invoiced<span class="field-type type-cost">COST</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Vendor shipping charges and misc fees (tariffs, taxes, etc.)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> po_profit.shipping_invoiced, po_profit.misc_invoiced
            </div>

            <div class="field-section">
                <div class="label">View Calculation:</div>
                <div class="code">-- Shipping Invoiced
sum(CASE WHEN fi.is_credit_memo = false
    THEN COALESCE(fi.freight, 0) + COALESCE(fi.dropship_fee, 0)
    ELSE 0 END) AS shipping_invoiced

-- Misc Invoiced
sum(CASE WHEN fi.is_credit_memo = false
    THEN COALESCE(fi.sales_tax, 0) + COALESCE(fi.misc_charge, 0) + COALESCE(fi.tariff_fee, 0)
    ELSE 0 END) AS misc_invoiced</div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Carrier Shipping<span class="field-type type-cost">COST</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Actual carrier shipping costs (UPS, FedEx, etc.) - separate from vendor charges</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> projects.carrier_shipping_cost (numeric)
            </div>

            <div class="dag-info">
                <strong>DAG:</strong> sync_projects.py<br>
                <strong>Task:</strong> house_sync_carrier_shipping_cost (line 138-174)
            </div>

            <div class="source-info">
                <strong>Source DB:</strong> house_postgres<br>
                <strong>Source Table:</strong> shipment_costs_flat<br>
                <strong>Aggregation:</strong> SUM(amount) grouped by project_id
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Product/Shipping/Misc CM<span class="field-type type-cost">COST</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Credit memos from vendors (credits we receive from suppliers)</div>
            </div>

            <div class="warehouse-info">
                <strong>Warehouse:</strong> po_profit.product_cm, po_profit.shipping_cm, po_profit.misc_cm
            </div>

            <div class="field-section">
                <div class="label">View Calculation:</div>
                <div class="code">-- Product CM
sum(CASE WHEN fi.is_credit_memo = true
    THEN fi.invoice_total - COALESCE(fi.freight, 0) - COALESCE(fi.dropship_fee, 0)
    ELSE 0 END) AS product_cm

-- Shipping CM
sum(CASE WHEN fi.is_credit_memo = true
    THEN COALESCE(fi.freight, 0) + COALESCE(fi.dropship_fee, 0)
    ELSE 0 END) AS shipping_cm

-- Misc CM
sum(CASE WHEN fi.is_credit_memo = true
    THEN COALESCE(fi.sales_tax, 0) + COALESCE(fi.misc_charge, 0) + COALESCE(fi.tariff_fee, 0)
    ELSE 0 END) AS misc_cm</div>
            </div>
        </div>

        <h2>üìâ Cost - Net (Calculated in Query)</h2>

        <div class="field-card">
            <div class="field-name">Product/Shipping/Misc Invoiced Net<span class="field-type type-calculated">CALCULATED</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Net costs after vendor credits (POSITIVE values = what we actually pay)</div>
            </div>

            <div class="field-section">
                <div class="label">Formula:</div>
                <div class="code">-- CORRECTED IN V3 (removed incorrect -1 multiplication)
Product Invoiced Net = product_invoiced - product_cm
Shipping Invoiced Net = shipping_invoiced - shipping_cm
Misc Invoiced Net = misc_invoiced - misc_cm
Carrier Shipping Net = carrier_shipping (no CM offset)</div>
            </div>

            <div class="field-section">
                <div class="label">Note on Sign:</div>
                <div class="value">
                    ‚úÖ All values are POSITIVE (costs we pay)<br>
                    ‚úÖ NO (-1) multiplication needed (po_profit already stores costs as positive)<br>
                    ‚úÖ Example: $1,000 invoiced - $100 CM = $900 net cost (positive)
                </div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Net Cost<span class="field-type type-calculated">CALCULATED</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Total costs after all vendor credits</div>
            </div>

            <div class="field-section">
                <div class="label">Formula:</div>
                <div class="code">Net Cost = (product_invoiced - product_cm) +
            (shipping_invoiced - shipping_cm) +
            (misc_invoiced - misc_cm) +
            carrier_shipping</div>
            </div>
        </div>

        <h2>üìà Gross Margin (Calculated in Query)</h2>

        <div class="field-card">
            <div class="field-name">Product/Shipping Margin Val<span class="field-type type-calculated">CALCULATED</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Profit margin in dollars (Revenue - Cost)</div>
            </div>

            <div class="field-section">
                <div class="label">Formula:</div>
                <div class="code">Product Margin Val = (product_revenue_invoiced - product_revenue_credit) -
                     (product_invoiced - product_cm)

Shipping Margin Val = (shipping_revenue_invoiced - shipping_revenue_credit) -
                       ((shipping_invoiced - shipping_cm) + carrier_shipping)</div>
            </div>

            <div class="field-section">
                <div class="label">Example:</div>
                <div class="value">
                    Revenue: $1,000 - Credits: $100 = <strong>$900 Net Revenue</strong><br>
                    Cost: $600 - CM: $50 = <strong>$550 Net Cost</strong><br>
                    Margin: $900 - $550 = <strong>$350 Profit</strong>
                </div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Gross Margin Val<span class="field-type type-calculated">CALCULATED</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Total gross margin (product + shipping margins combined)</div>
            </div>

            <div class="field-section">
                <div class="label">Formula:</div>
                <div class="code">Gross Margin Val = Product Margin Val + Shipping Margin Val</div>
            </div>
        </div>

        <div class="field-card">
            <div class="field-name">Product/Shipping/Gross Margin Pct<span class="field-type type-calculated">CALCULATED</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">Margin as percentage of revenue (Margin / Revenue * 100)</div>
            </div>

            <div class="field-section">
                <div class="label">Formula:</div>
                <div class="code">Product Margin Pct = (Product Margin Val / Product Revenue Net) * 100

Shipping Margin Pct = (Shipping Margin Val / Shipping Revenue Net) * 100

Gross Margin Pct = (Gross Margin Val / (Product Rev Net + Shipping Rev Net)) * 100</div>
            </div>

            <div class="field-section">
                <div class="label">Example:</div>
                <div class="value">
                    Margin: $350 / Revenue: $900 = <strong>38.89% Margin</strong><br>
                    Higher % = Better profitability
                </div>
            </div>
        </div>

        <h2>üêõ Debug Fields</h2>

        <div class="field-card">
            <div class="field-name">All Orders Complete<span class="field-type type-reference">DEBUG</span></div>

            <div class="field-section">
                <div class="label">Description:</div>
                <div class="value">TRUE if all orders in project are in terminal states (complete, closed, canceled, fully_refunded)</div>
            </div>

            <div class="field-section">
                <div class="label">Calculation:</div>
                <div class="code">SELECT
    project_id,
    BOOL_AND(order_state IN ('complete', 'closed', 'canceled', 'fully_refunded')) AS all_orders_complete
FROM orders
WHERE project_id IS NOT NULL
GROUP BY project_id</div>
            </div>
        </div>

        <h2>üîÑ Data Flow Summary</h2>

        <table>
            <thead>
                <tr>
                    <th>Data Category</th>
                    <th>Ultimate Source</th>
                    <th>Processing Path</th>
                    <th>Warehouse Location</th>
                    <th>Update Frequency</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Revenue Fields (8)</strong></td>
                    <td>QuickBooks</td>
                    <td>QB ‚Üí Loome Invoice/CM ‚Üí Stats Calc ‚Üí project.daily_stat ‚Üí DAG ‚Üí projects table</td>
                    <td>projects.product_revenue_invoiced, etc.</td>
                    <td>Hourly</td>
                </tr>
                <tr>
                    <td><strong>Cost Fields (6)</strong></td>
                    <td>House DB finance_invoice</td>
                    <td>finance_invoice ‚Üí v_po_profit_2025 ‚Üí po_profit table ‚Üí Aggregated by project</td>
                    <td>po_profit.product_invoiced, etc.</td>
                    <td>Real-time (view)</td>
                </tr>
                <tr>
                    <td><strong>Carrier Shipping</strong></td>
                    <td>House DB shipment_costs_flat</td>
                    <td>shipment_costs_flat ‚Üí DAG aggregation ‚Üí projects.carrier_shipping_cost</td>
                    <td>projects.carrier_shipping_cost</td>
                    <td>Hourly</td>
                </tr>
                <tr>
                    <td><strong>Reference Fields</strong></td>
                    <td>House DB + Loome</td>
                    <td>v_project_items + Loome project table ‚Üí DAG ‚Üí projects table</td>
                    <td>projects.account_name, etc.</td>
                    <td>Hourly</td>
                </tr>
                <tr>
                    <td><strong>Calculated Fields</strong></td>
                    <td>N/A</td>
                    <td>Calculated in query at runtime</td>
                    <td>Query output only</td>
                    <td>Real-time</td>
                </tr>
            </tbody>
        </table>

        <h2>‚ö° Performance Improvements in V3</h2>

        <div class="summary">
            <h3>V3 vs V2 Comparison</h3>

            <table>
                <thead>
                    <tr>
                        <th>Aspect</th>
                        <th>V2 (Old)</th>
                        <th>V3 (New)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Revenue Source</strong></td>
                        <td>Complex joins on orders + order_items + invoices tables</td>
                        <td>Simple read from projects table (pre-calculated)</td>
                    </tr>
                    <tr>
                        <td><strong>Credit Source</strong></td>
                        <td>Complex joins on refunds + orders tables</td>
                        <td>Simple read from projects table (pre-calculated)</td>
                    </tr>
                    <tr>
                        <td><strong>Performance</strong></td>
                        <td>Slow (aggregations on large tables)</td>
                        <td>10-100x faster (indexed reads only)</td>
                    </tr>
                    <tr>
                        <td><strong>Accuracy</strong></td>
                        <td>Approximate (Magento order data)</td>
                        <td>Exact (QuickBooks invoice data)</td>
                    </tr>
                    <tr>
                        <td><strong>Maintenance</strong></td>
                        <td>Complex query logic to maintain</td>
                        <td>Simple query, logic in Loome stats system</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2>‚ö†Ô∏è Important Notes</h2>

        <div class="field-section" style="background-color: #e1f5fe; border-left: 4px solid #03a9f4;">
            <h3 style="color: #01579b; margin-top: 0;">Loome Finance Stats System</h3>
            <p><strong>Location:</strong> Loome apps/finance/stats.py</p>
            <p><strong>Key Functions:</strong></p>
            <ul>
                <li><strong>_update_invoice_stats():</strong> Parses QB invoice JSON to categorize line items into product/shipping/tax/fees</li>
                <li><strong>_update_credit_memo_stats():</strong> Parses QB credit memo JSON (same categorization logic)</li>
                <li><strong>_update_project_stats():</strong> Aggregates all invoice/CM stats to project level</li>
            </ul>
            <p><strong>Storage:</strong> project.daily_stat JSONB field contains all aggregated stats</p>
            <p><strong>Trigger:</strong> Updated automatically when invoices/CMs are synced from QuickBooks</p>
        </div>

        <div class="field-section" style="background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <h3 style="color: #856404; margin-top: 0;">Data Quality Considerations</h3>
            <ul>
                <li><strong>Cost Sign Convention:</strong> All costs are POSITIVE values (what we pay). NO (-1) multiplication needed.</li>
                <li><strong>Single Source of Truth:</strong> Revenue data comes from Loome (QuickBooks), not Magento orders</li>
                <li><strong>Pre-Aggregation:</strong> All revenue stats are pre-calculated in Loome for performance</li>
                <li><strong>Deposit Handling:</strong> Loome stats exclude deposit invoices from revenue calculations</li>
                <li><strong>Project Filter:</strong> Query filters to only show projects with revenue activity (product_revenue_invoiced > 0 OR product_revenue_credit > 0)</li>
            </ul>
        </div>

        <div style="margin-top: 50px; padding-top: 20px; border-top: 2px solid #ddd; text-align: center; color: #7f8c8d;">
            <p><strong>Report Generated:</strong> 2025-11-19</p>
            <p>This documentation traces all fields in project_pnl_query_v3.sql from their ultimate source systems through processing pipelines to the final query output</p>
        </div>
    </div>
</body>
</html>
