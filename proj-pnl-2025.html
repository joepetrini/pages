<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project P&L Report V3 - Field Documentation</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 2000px;
            margin: 0 auto;
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #667eea;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 32px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 24px;
        }
        .summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #2196f3;
            padding: 25px;
            border-radius: 8px;
            margin: 30px 0;
        }
        .summary h3 {
            margin-top: 0;
            color: #1565c0;
        }
        .summary p {
            margin: 8px 0;
        }

        /* Main fields table */
        .fields-table-container {
            overflow-x: auto;
            margin: 30px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .fields-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            font-size: 13px;
        }
        .fields-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .fields-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        .fields-table th:last-child {
            border-right: none;
        }
        .fields-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top;
            line-height: 1.5;
        }
        .fields-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .fields-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        /* Category badges */
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 6px;
        }
        .cat-reference { background-color: #e3f2fd; color: #1976d2; }
        .cat-revenue { background-color: #e8f5e9; color: #388e3c; }
        .cat-cost { background-color: #ffebee; color: #d32f2f; }
        .cat-calculated { background-color: #f3e5f5; color: #7b1fa2; }
        .cat-loome { background-color: #e1f5fe; color: #03a9f4; }
        .cat-debug { background-color: #fff3e0; color: #f57c00; }

        /* Field name styling */
        .field-name {
            font-weight: bold;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        /* Source info pills */
        .source-pill {
            display: inline-block;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            margin: 2px;
            font-family: monospace;
        }
        .source-loome { background-color: #e1f5fe; color: #01579b; }
        .source-house { background-color: #ffebee; color: #b71c1c; }
        .source-warehouse { background-color: #fff3e0; color: #e65100; }

        /* Code snippets */
        .code-inline {
            background-color: #f5f5f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #c7254e;
        }

        /* Category summary table */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .summary-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .summary-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .summary-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Data flow table */
        .dataflow-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 12px;
        }
        .dataflow-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        .dataflow-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        .dataflow-table tr:hover {
            background-color: #f8f9fa;
        }

        /* Notes section */
        .note-section {
            background-color: #e1f5fe;
            border-left: 4px solid #03a9f4;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .note-section h3 {
            color: #01579b;
            margin-top: 0;
            font-size: 16px;
        }
        .note-section ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .note-section li {
            margin: 5px 0;
        }

        .warning-section {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .warning-section h3 {
            color: #856404;
            margin-top: 0;
            font-size: 16px;
        }

        /* Footer */
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            text-align: center;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Project P&L Report V3 - Field Documentation</h1>

        <div class="summary">
            <h3>Report Overview</h3>
            <p><strong>Query File:</strong> project_pnl_query_v3.sql</p>
            <p><strong>Target Database:</strong> warehouse (PostgreSQL)</p>
            <p><strong>Primary Table:</strong> public.projects</p>
            <p><strong>Purpose:</strong> Comprehensive project-level P&L analysis with revenue (from Loome finance stats), costs (from validated po_profit), and margin calculations</p>
            <p><strong>Major Improvement in V3:</strong> Uses pre-calculated finance stats from Loome instead of complex joins on orders/invoices - 10-100x faster!</p>
        </div>

        <h2>üìã Field Categories Summary</h2>
        <table class="summary-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Field Count</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Reference Fields</strong></td>
                    <td>11</td>
                    <td>Project identifiers and metadata (dates, names, counts, status)</td>
                </tr>
                <tr>
                    <td><strong>Revenue - Invoiced (from Loome)</strong></td>
                    <td>4</td>
                    <td>Customer revenue from invoices (product, shipping, tax, fees)</td>
                </tr>
                <tr>
                    <td><strong>Revenue - Credits (from Loome)</strong></td>
                    <td>4</td>
                    <td>Customer refunds from credit memos (product, shipping, tax, fees)</td>
                </tr>
                <tr>
                    <td><strong>Revenue - Net (Calculated)</strong></td>
                    <td>5</td>
                    <td>Net revenue after credits (invoiced - credits)</td>
                </tr>
                <tr>
                    <td><strong>Cost - Billed (from po_profit)</strong></td>
                    <td>7</td>
                    <td>Vendor costs and carrier shipping (product, shipping, misc, carrier, CMs)</td>
                </tr>
                <tr>
                    <td><strong>Cost - Net (Calculated)</strong></td>
                    <td>5</td>
                    <td>Net costs after vendor credits (invoiced - CMs)</td>
                </tr>
                <tr>
                    <td><strong>Gross Margin (Calculated)</strong></td>
                    <td>6</td>
                    <td>Profit margins (values and percentages)</td>
                </tr>
                <tr>
                    <td><strong>Debug Fields</strong></td>
                    <td>3</td>
                    <td>Status flags and timestamps</td>
                </tr>
            </tbody>
        </table>

        <h2>üìä All Fields - Complete Reference</h2>

        <div class="fields-table-container">
            <table class="fields-table">
                <thead>
                    <tr>
                        <th style="width: 15%;">Field Name</th>
                        <th style="width: 8%;">Category</th>
                        <th style="width: 20%;">Description</th>
                        <th style="width: 15%;">Warehouse Location</th>
                        <th style="width: 22%;">Data Source / DAG</th>
                        <th style="width: 20%;">Calculation / Logic</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- REFERENCE FIELDS -->
                    <tr>
                        <td class="field-name">Project ID</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Unique identifier for the project (UUID)</td>
                        <td><span class="code-inline">projects.project_id</span> (uuid)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            View: <span class="code-inline">v_project_items</span><br>
                            DAG: sync_projects.py ‚Üí house_sync_projects
                        </td>
                        <td>Source field: <span class="code-inline">opportunity_id</span> from House DB crm_opportunity</td>
                    </tr>
                    <tr>
                        <td class="field-name">Account</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Account organization name (parent company)</td>
                        <td><span class="code-inline">projects.account_name</span> (varchar)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            Table: <span class="code-inline">project ‚Üí organization</span><br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>Loome field: <span class="code-inline">o.name</span> (account_organization)</td>
                    </tr>
                    <tr>
                        <td class="field-name">Customer</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Customer organization name (end customer)</td>
                        <td><span class="code-inline">projects.customer_name</span> (varchar)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            Table: <span class="code-inline">project ‚Üí organization</span><br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>Loome field: <span class="code-inline">co.name</span> (customer_organization)</td>
                    </tr>
                    <tr>
                        <td class="field-name">Project</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Project name/title</td>
                        <td><span class="code-inline">projects.name</span> (varchar)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            View: <span class="code-inline">v_project_items</span><br>
                            DAG: sync_projects.py ‚Üí house_sync_projects
                        </td>
                        <td>Source field: <span class="code-inline">project_name</span></td>
                    </tr>
                    <tr>
                        <td class="field-name">Project Manager</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Project manager name from Loome</td>
                        <td><span class="code-inline">projects.project_manager</span> (varchar)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            Table: <span class="code-inline">project ‚Üí core_users</span><br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td><span class="code-inline">CONCAT(u.first_name, ' ', u.last_name)</span></td>
                    </tr>
                    <tr>
                        <td class="field-name">State</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Shipping state (US state code)</td>
                        <td><span class="code-inline">projects.state</span> (varchar)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>Loome: <span class="code-inline">p.address->>'state'</span> (JSONB extraction)</td>
                    </tr>
                    <tr>
                        <td class="field-name">First Order Date</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Date of first order in project</td>
                        <td><span class="code-inline">projects.first_order_date</span> (date)</td>
                        <td>
                            <span class="source-pill source-warehouse">warehouse</span><br>
                            DAG: sync_projects.py ‚Üí house_sync_order_metrics
                        </td>
                        <td><span class="code-inline">MIN(created_at::date)</span> from orders table</td>
                    </tr>
                    <tr>
                        <td class="field-name">Last Order Date</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Date of most recent order in project</td>
                        <td><span class="code-inline">projects.last_order_date</span> (date)</td>
                        <td>
                            <span class="source-pill source-warehouse">warehouse</span><br>
                            DAG: sync_projects.py ‚Üí house_sync_order_metrics
                        </td>
                        <td><span class="code-inline">MAX(created_at::date)</span> from orders table</td>
                    </tr>
                    <tr>
                        <td class="field-name">Order Count</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Total number of orders in project</td>
                        <td><span class="code-inline">projects.order_count</span> (int)</td>
                        <td>
                            <span class="source-pill source-warehouse">warehouse</span><br>
                            DAG: sync_projects.py ‚Üí house_sync_order_metrics
                        </td>
                        <td><span class="code-inline">COUNT(*)</span> from orders table grouped by project_id</td>
                    </tr>
                    <tr>
                        <td class="field-name">PO Count</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Total number of purchase orders in project</td>
                        <td><span class="code-inline">projects.po_count</span> (int)</td>
                        <td>
                            <span class="source-pill source-warehouse">warehouse</span><br>
                            DAG: sync_projects.py ‚Üí house_sync_order_metrics
                        </td>
                        <td><span class="code-inline">COUNT(DISTINCT po.increment_id)</span> from purchase_orders</td>
                    </tr>
                    <tr>
                        <td class="field-name">Status</td>
                        <td><span class="category-badge cat-reference">Reference</span></td>
                        <td>Project status from Loome</td>
                        <td><span class="code-inline">projects.status</span> (varchar)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>Loome field: <span class="code-inline">p.status</span></td>
                    </tr>

                    <!-- REVENUE - INVOICED -->
                    <tr style="border-top: 3px solid #667eea;">
                        <td class="field-name">Product Revenue Invoiced</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>Total product revenue from customer invoices (excludes tax, shipping, fees)</td>
                        <td><span class="code-inline">projects.product_revenue_invoiced</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome Invoice ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'product_invoiced'</span><br>
                            Stats: apps/finance/stats.py ‚Üí _update_invoice_stats()<br>
                            QB Accounts: "Sales", "Fixtures & Bulb"
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping Revenue Invoiced</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>Shipping charges billed to customer on invoices</td>
                        <td><span class="code-inline">projects.shipping_revenue_invoiced</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome Invoice ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'shipping_invoiced'</span><br>
                            QB Accounts: "Freight", "Shipping & Handling"
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Sales Tax Invoiced</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>Sales tax collected from customer on invoices</td>
                        <td><span class="code-inline">projects.sales_tax_invoiced</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome Invoice ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'tax_invoiced'</span><br>
                            QB Account: "Sales Tax" OR calc: total_incl_tax - total_excl_tax
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Fees Invoiced</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>All fees charged to customer (credit card fees + design fees)</td>
                        <td><span class="code-inline">projects.fees_invoiced</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome Invoice ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'fees_invoiced'</span><br>
                            Calc: credit_card_fees + design_fees<br>
                            QB Accounts: "Fee Income", "Credit Card Fee", "Professional"
                        </td>
                    </tr>

                    <!-- REVENUE - CREDITS -->
                    <tr style="border-top: 3px solid #667eea;">
                        <td class="field-name">Product Revenue Credit</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>Product refunds/credits issued to customer via credit memos</td>
                        <td><span class="code-inline">projects.product_revenue_credit</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome CreditMemo ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'product_credit'</span><br>
                            Stats: apps/finance/stats.py ‚Üí _update_credit_memo_stats()<br>
                            QB Accounts: "Sales", "Fixtures & Bulb" (same as invoice)
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping Revenue Credit</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>Shipping refunds from credit memos</td>
                        <td><span class="code-inline">projects.shipping_revenue_credit</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome CreditMemo ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'shipping_credit'</span><br>
                            QB Accounts: "Freight", "Shipping & Handling"
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Sales Tax Credit</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>Sales tax refunds from credit memos</td>
                        <td><span class="code-inline">projects.sales_tax_credit</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome CreditMemo ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'credit_memo_tax_refunded'</span><br>
                            QB Account: "Sales Tax"
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Fees Credit</td>
                        <td><span class="category-badge cat-loome">Revenue</span></td>
                        <td>Fee refunds from credit memos</td>
                        <td><span class="code-inline">projects.fees_credit</span> (numeric 12,2)</td>
                        <td>
                            <span class="source-pill source-loome">loome_postgres</span><br>
                            QuickBooks ‚Üí Loome CreditMemo ‚Üí Stats Calc<br>
                            DAG: sync_projects.py ‚Üí loome_project_manager
                        </td>
                        <td>
                            Loome: <span class="code-inline">p.daily_stat->>'fees_credit'</span><br>
                            QB Accounts: Same as fees_invoiced
                        </td>
                    </tr>

                    <!-- REVENUE - NET (CALCULATED) -->
                    <tr style="border-top: 3px solid #667eea;">
                        <td class="field-name">Product Revenue Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Net product revenue after refunds</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">product_revenue_invoiced - product_revenue_credit</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping Revenue Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Net shipping revenue after refunds</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">shipping_revenue_invoiced - shipping_revenue_credit</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Sales Tax Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Net sales tax after refunds</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">sales_tax_invoiced - sales_tax_credit</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Fees Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Net fees after refunds</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">fees_invoiced - fees_credit</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Net Revenue</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Total net revenue (product + shipping only, excludes tax and fees per spec)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">(product_revenue_invoiced - product_revenue_credit) + (shipping_revenue_invoiced - shipping_revenue_credit)</span>
                        </td>
                    </tr>

                    <!-- COST - BILLED -->
                    <tr style="border-top: 3px solid #667eea;">
                        <td class="field-name">Product Invoiced</td>
                        <td><span class="category-badge cat-cost">Cost</span></td>
                        <td>Total amount invoiced by vendors for products (what we pay suppliers)</td>
                        <td><span class="code-inline">po_profit.product_invoiced</span> (numeric)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            Table: finance_invoice<br>
                            View: v_po_profit_2025<br>
                            Query aggregates by project_id
                        </td>
                        <td>
                            View calc:<br>
                            <span class="code-inline">SUM(CASE WHEN is_credit_memo = false THEN invoice_total - freight - dropship_fee END)</span><br>
                            Filters: is_validated=true, is_ignored=false
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping Invoiced</td>
                        <td><span class="category-badge cat-cost">Cost</span></td>
                        <td>Vendor shipping charges (freight + dropship fees)</td>
                        <td><span class="code-inline">po_profit.shipping_invoiced</span> (numeric)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            Table: finance_invoice<br>
                            View: v_po_profit_2025
                        </td>
                        <td>
                            View calc:<br>
                            <span class="code-inline">SUM(CASE WHEN is_credit_memo = false THEN freight + dropship_fee END)</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Misc Invoiced</td>
                        <td><span class="category-badge cat-cost">Cost</span></td>
                        <td>Misc vendor fees (tariffs, taxes, misc charges)</td>
                        <td><span class="code-inline">po_profit.misc_invoiced</span> (numeric)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            Table: finance_invoice<br>
                            View: v_po_profit_2025
                        </td>
                        <td>
                            View calc:<br>
                            <span class="code-inline">SUM(CASE WHEN is_credit_memo = false THEN sales_tax + misc_charge + tariff_fee END)</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Carrier Shipping</td>
                        <td><span class="category-badge cat-cost">Cost</span></td>
                        <td>Actual carrier shipping costs (UPS, FedEx, etc.) - separate from vendor charges</td>
                        <td><span class="code-inline">projects.carrier_shipping_cost</span> (numeric)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            Table: shipment_costs_flat<br>
                            DAG: sync_projects.py ‚Üí house_sync_carrier_shipping_cost
                        </td>
                        <td>
                            Aggregation:<br>
                            <span class="code-inline">SUM(amount)</span> grouped by project_id<br>
                            Filter: ignored_at IS NULL
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Product CM</td>
                        <td><span class="category-badge cat-cost">Cost</span></td>
                        <td>Product credit memos from vendors (credits we receive from suppliers)</td>
                        <td><span class="code-inline">po_profit.product_cm</span> (numeric)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            Table: finance_invoice<br>
                            View: v_po_profit_2025
                        </td>
                        <td>
                            View calc:<br>
                            <span class="code-inline">SUM(CASE WHEN is_credit_memo = true THEN invoice_total - freight - dropship_fee END)</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping CM</td>
                        <td><span class="category-badge cat-cost">Cost</span></td>
                        <td>Shipping credit memos from vendors</td>
                        <td><span class="code-inline">po_profit.shipping_cm</span> (numeric)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            Table: finance_invoice<br>
                            View: v_po_profit_2025
                        </td>
                        <td>
                            View calc:<br>
                            <span class="code-inline">SUM(CASE WHEN is_credit_memo = true THEN freight + dropship_fee END)</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Misc CM</td>
                        <td><span class="category-badge cat-cost">Cost</span></td>
                        <td>Misc credit memos from vendors</td>
                        <td><span class="code-inline">po_profit.misc_cm</span> (numeric)</td>
                        <td>
                            <span class="source-pill source-house">house_postgres</span><br>
                            Table: finance_invoice<br>
                            View: v_po_profit_2025
                        </td>
                        <td>
                            View calc:<br>
                            <span class="code-inline">SUM(CASE WHEN is_credit_memo = true THEN sales_tax + misc_charge + tariff_fee END)</span>
                        </td>
                    </tr>

                    <!-- COST - NET (CALCULATED) -->
                    <tr style="border-top: 3px solid #667eea;">
                        <td class="field-name">Product Invoiced Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Net product costs after vendor credits (POSITIVE = what we actually pay)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">product_invoiced - product_cm</span><br>
                            ‚úÖ All values POSITIVE (no -1 multiplication)
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping Invoiced Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Net shipping costs after vendor credits</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">shipping_invoiced - shipping_cm</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Misc Invoiced Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Net misc costs after vendor credits</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">misc_invoiced - misc_cm</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Carrier Shipping Net</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Carrier shipping (no CM offset available)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">carrier_shipping</span> (same as gross)
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Net Cost</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Total costs after all vendor credits</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">(product_invoiced - product_cm) + (shipping_invoiced - shipping_cm) + (misc_invoiced - misc_cm) + carrier_shipping</span>
                        </td>
                    </tr>

                    <!-- GROSS MARGIN (CALCULATED) -->
                    <tr style="border-top: 3px solid #667eea;">
                        <td class="field-name">Product Margin Val</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Product profit margin in dollars (Revenue - Cost)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">(product_revenue_invoiced - product_revenue_credit) - (product_invoiced - product_cm)</span><br>
                            Example: $900 rev - $550 cost = $350 margin
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping Margin Val</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Shipping profit margin in dollars</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">(shipping_revenue_invoiced - shipping_revenue_credit) - ((shipping_invoiced - shipping_cm) + carrier_shipping)</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Gross Margin Val</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Total gross margin (product + shipping margins combined)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">Product Margin Val + Shipping Margin Val</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Product Margin Pct</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Product margin as percentage of revenue</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">(Product Margin Val / Product Revenue Net) * 100</span><br>
                            Example: $350 / $900 = 38.89%
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Shipping Margin Pct</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Shipping margin as percentage of revenue</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">(Shipping Margin Val / Shipping Revenue Net) * 100</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Gross Margin Pct</td>
                        <td><span class="category-badge cat-calculated">Calculated</span></td>
                        <td>Gross margin as percentage of total revenue</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">(Gross Margin Val / (Product Rev Net + Shipping Rev Net)) * 100</span>
                        </td>
                    </tr>

                    <!-- DEBUG FIELDS -->
                    <tr style="border-top: 3px solid #667eea;">
                        <td class="field-name">All Orders Complete</td>
                        <td><span class="category-badge cat-debug">Debug</span></td>
                        <td>TRUE if all orders in project are in terminal states (complete, closed, canceled, fully_refunded)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">warehouse.orders</span><br>
                            Calculated in query
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">BOOL_AND(order_state IN ('complete', 'closed', 'canceled', 'fully_refunded'))</span><br>
                            Grouped by project_id
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Pct Invoiced</td>
                        <td><span class="category-badge cat-debug">Debug</span></td>
                        <td>Percentage of order value that has been invoiced (TODO)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill">Not yet implemented</span>
                        </td>
                        <td>
                            ‚è≥ TODO: Need to calculate net order value vs invoiced amount
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Has Pull From Stock</td>
                        <td><span class="category-badge cat-debug">Debug</span></td>
                        <td>TRUE if project has any POs with 'pull_from_stock' workflow (TODO)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill">Not yet implemented</span>
                        </td>
                        <td>
                            ‚è≥ TODO: Check purchase_orders.workflow field for 'pull_from_stock'
                        </td>
                    </tr>
                    <tr>
                        <td class="field-name">Current DateStamp YYYYMMDD</td>
                        <td><span class="category-badge cat-debug">Debug</span></td>
                        <td>Current date in YYYYMMDD format (report run date)</td>
                        <td><span class="code-inline">Query output only</span></td>
                        <td>
                            <span class="source-pill source-warehouse">Runtime calculation</span>
                        </td>
                        <td>
                            Formula:<br>
                            <span class="code-inline">TO_CHAR(CURRENT_DATE, 'YYYYMMDD')</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2>üîÑ Data Flow Summary</h2>

        <table class="dataflow-table">
            <thead>
                <tr>
                    <th>Data Category</th>
                    <th>Ultimate Source</th>
                    <th>Processing Path</th>
                    <th>Warehouse Location</th>
                    <th>Update Frequency</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Revenue Fields (8)</strong></td>
                    <td>QuickBooks</td>
                    <td>QB ‚Üí Loome Invoice/CM ‚Üí Stats Calc ‚Üí project.daily_stat ‚Üí DAG ‚Üí projects table</td>
                    <td>projects.product_revenue_invoiced, etc.</td>
                    <td>Hourly</td>
                </tr>
                <tr>
                    <td><strong>Cost Fields (6)</strong></td>
                    <td>House DB finance_invoice</td>
                    <td>finance_invoice ‚Üí v_po_profit_2025 ‚Üí po_profit table ‚Üí Aggregated by project</td>
                    <td>po_profit.product_invoiced, etc.</td>
                    <td>Real-time (view)</td>
                </tr>
                <tr>
                    <td><strong>Carrier Shipping</strong></td>
                    <td>House DB shipment_costs_flat</td>
                    <td>shipment_costs_flat ‚Üí DAG aggregation ‚Üí projects.carrier_shipping_cost</td>
                    <td>projects.carrier_shipping_cost</td>
                    <td>Hourly</td>
                </tr>
                <tr>
                    <td><strong>Reference Fields</strong></td>
                    <td>House DB + Loome</td>
                    <td>v_project_items + Loome project table ‚Üí DAG ‚Üí projects table</td>
                    <td>projects.account_name, etc.</td>
                    <td>Hourly</td>
                </tr>
                <tr>
                    <td><strong>Calculated Fields</strong></td>
                    <td>N/A</td>
                    <td>Calculated in query at runtime</td>
                    <td>Query output only</td>
                    <td>Real-time</td>
                </tr>
            </tbody>
        </table>

        <h2>‚ö° Performance Improvements in V3</h2>

        <table class="dataflow-table">
            <thead>
                <tr>
                    <th>Aspect</th>
                    <th>V2 (Old)</th>
                    <th>V3 (New)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Revenue Source</strong></td>
                    <td>Complex joins on orders + order_items + invoices tables</td>
                    <td>Simple read from projects table (pre-calculated)</td>
                </tr>
                <tr>
                    <td><strong>Credit Source</strong></td>
                    <td>Complex joins on refunds + orders tables</td>
                    <td>Simple read from projects table (pre-calculated)</td>
                </tr>
                <tr>
                    <td><strong>Performance</strong></td>
                    <td>Slow (aggregations on large tables)</td>
                    <td>10-100x faster (indexed reads only)</td>
                </tr>
                <tr>
                    <td><strong>Accuracy</strong></td>
                    <td>Approximate (Magento order data)</td>
                    <td>Exact (QuickBooks invoice data)</td>
                </tr>
                <tr>
                    <td><strong>Maintenance</strong></td>
                    <td>Complex query logic to maintain</td>
                    <td>Simple query, logic in Loome stats system</td>
                </tr>
            </tbody>
        </table>

        <h2>‚ö†Ô∏è Important Notes</h2>

        <div class="note-section">
            <h3>Loome Finance Stats System</h3>
            <p><strong>Location:</strong> Loome apps/finance/stats.py</p>
            <p><strong>Key Functions:</strong></p>
            <ul>
                <li><strong>_update_invoice_stats():</strong> Parses QB invoice JSON to categorize line items into product/shipping/tax/fees</li>
                <li><strong>_update_credit_memo_stats():</strong> Parses QB credit memo JSON (same categorization logic)</li>
                <li><strong>_update_project_stats():</strong> Aggregates all invoice/CM stats to project level</li>
            </ul>
            <p><strong>Storage:</strong> project.daily_stat JSONB field contains all aggregated stats</p>
            <p><strong>Trigger:</strong> Updated automatically when invoices/CMs are synced from QuickBooks</p>
        </div>

        <div class="warning-section">
            <h3>Data Quality Considerations</h3>
            <ul>
                <li><strong>Cost Sign Convention:</strong> All costs are POSITIVE values (what we pay). NO (-1) multiplication needed.</li>
                <li><strong>Single Source of Truth:</strong> Revenue data comes from Loome (QuickBooks), not Magento orders</li>
                <li><strong>Pre-Aggregation:</strong> All revenue stats are pre-calculated in Loome for performance</li>
                <li><strong>Deposit Handling:</strong> Loome stats exclude deposit invoices from revenue calculations</li>
                <li><strong>Project Filter:</strong> Query filters to only show projects with revenue activity (product_revenue_invoiced > 0 OR product_revenue_credit > 0)</li>
                <li><strong>Cost Validation:</strong> Only validated, non-ignored vendor invoices are included (is_validated=true, is_ignored=false in finance_invoice)</li>
            </ul>
        </div>

        <div class="footer">
            <p><strong>Report Generated:</strong> 2025-11-19</p>
            <p>This documentation traces all 45+ fields in project_pnl_query_v3.sql from their ultimate source systems through processing pipelines to the final query output</p>
        </div>
    </div>
</body>
</html>
